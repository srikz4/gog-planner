<html lang="en">
<head>
    <title>shriekz's Upgrade Planner</title>
    <meta charset="utf-8" />
    <link href="style.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>

<body>

<header>
  <h1>Welcome to the Upgrade Planner v1.0</h1>
</header>

<section id="result">
    <h2>Here's your suggested plan to reach Castle <output id="castleTarget"></output> by <output id="castleTargetBy"></output> : </h2>
    <article>
        <p>Total Time : <output id="totalTime"></output></p>
        <br />
        <p>Total Rss Needed : </p>
        <ul id="targetRssCost"></ul>
        <br />
        <p>In addition to the above, you'd also need to upgrade the following buildings : </p>
        <ul id="targetUpgrades"></ul>
        <br />
        <p>Note : The time and rss needed are inclusive of the upgrade cost for the requisite buildings</p>

        <form method="POST" action="javascript:cleanUp();">
            <button>Plan Again</button>
        </form>
    </article>
</section>

<section id="planner">
  <h2>Tell me where you're currently at : </h2>
  <article>
    <h3>Provide some info about what your current building levels are. Also provide your current standings at Spirit Mines and Catacombs. For buildings outside walls, only pick the highest level you have</h3>
    <form method="POST" action="javascript:doSubmit();">
  
        <fieldset>
          <label for="plan_id">Provide a Plan Identifer</label>
          <input type="text" name="plan_id" id="plan_id" placeholder="Ex: My Super Growth">
        </fieldset>
      
        <h4>Provide your targets here : </h4>
        <div class="cols">
            <div class="col-2">
                <fieldset>
                    <label for="castle_to">Target Castle Level</label>
                    <input type="number" required name="castle_to" id="castle_to" min="2" max="40" value="22">
                </fieldset>
            </div>

            <div class="col-2">
                <fieldset>
                    <label for="targetBy">Upgrade By</label>
                    <input type="date" required name="targetBy" id="targetBy" value="">
                </fieldset>
            </div>
        </div>

        <fieldset>
            <label for="castle">Castle</label> - <output id="castleLvl">20</output>
            <input type="range" name="castle" id="castle" min="1" max="40" value="20" oninput="castleLvl.value = castle.value; reflectTarget();">
        </fieldset>
  
        <div class="cols">
            <div class="col-3">
                <fieldset>
                    <label for="infantry">Barracks</label> - <output id="infantryLvl">20</output>
                    <input type="range" name="infantry" id="infantry" min="1" max="40" value="20" oninput="infantryLvl.value = infantry.value">
                </fieldset>

                <fieldset>
                    <label for="cavalry">Stables</label> - <output id="cavalryLvl">20</output>
                    <input type="range" name="cavalry" id="cavalry" min="1" max="40" value="20" oninput="cavalryLvl.value = cavalry.value">
                </fieldset>

                <fieldset>
                    <label for="distance">Shooting Range</label> - <output id="distanceLvl">20</output>
                    <input type="range" name="distance" id="distance" min="1" max="40" value="20" oninput="distanceLvl.value = distance.value">
                </fieldset>

                <fieldset>
                    <label for="artillery">Artillery Foundry</label> - <output id="artilleryLvl">20</output>
                    <input type="range" name="artillery" id="artillery" min="1" max="40" value="20" oninput="artilleryLvl.value = artillery.value">
                </fieldset>

                <fieldset>
                    <label for="traps">Trap Factory</label> - <output id="trapsLvl">20</output>
                    <input type="range" name="traps" id="traps" min="1" max="40" value="20" oninput="trapsLvl.value = traps.value">
                </fieldset>
            </div>

            <div class="col-3">
                <fieldset>
                    <label for="wall">Wall</label> - <output id="wallLvl">20</output>
                    <input type="range" name="wall" id="wall" min="1" max="40" value="20" oninput="wallLvl.value = wall.value">
                </fieldset>

                <fieldset>
                    <label for="lookout">Lookout Tower</label> - <output id="lookoutLvl">20</output>
                    <input type="range" name="lookout" id="lookout" min="1" max="40" value="20" oninput="lookoutLvl.value = lookout.value">
                </fieldset>

                <fieldset>
                    <label for="airship">Airship Dock</label> - <output id="airshipLvl">20</output>
                    <input type="range" name="airship" id="airship" min="1" max="40" value="20" oninput="airshipLvl.value = airship.value">
                </fieldset>

                <fieldset>
                    <label for="forge">Forge</label> - <output id="forgeLvl">20</output>
                    <input type="range" name="forge" id="forge" min="1" max="40" value="20" oninput="forgeLvl.value = forge.value">
                </fieldset>

                <fieldset>
                    <label for="academy">Academy</label> - <output id="academyLvl">20</output>
                    <input type="range" name="academy" id="academy" min="1" max="40" value="20" oninput="academyLvl.value = academy.value">
                </fieldset>
            </div>

            <div class="col-3">
                <fieldset>
                    <label for="warehouse">Warehouse</label> - <output id="warehouseLvl">20</output>
                    <input type="range" name="warehouse" id="warehouse" min="1" max="40" value="20" oninput="warehouseLvl.value = warehouse.value">
                </fieldset>

                <fieldset>
                    <label for="embassy">Embassy</label> - <output id="embassyLvl">20</output>
                    <input type="range" name="embassy" id="embassy" min="1" max="40" value="20" oninput="embassyLvl.value = embassy.value">
                </fieldset>

                <fieldset>
                    <label for="warhall">Hall of War</label> - <output id="warhallLvl">20</output>
                    <input type="range" name="warhall" id="warhall" min="1" max="40" value="20" oninput="warhallLvl.value = warhall.value">
                </fieldset>

                <fieldset>
                    <label for="munitions">Munitions Exchange</label> - <output id="munitionsLvl">20</output>
                    <input type="range" name="munitions" id="munitions" min="1" max="40" value="20" oninput="munitionsLvl.value = munitions.value">
                </fieldset>

                <fieldset>
                    <label for="trade">Trade Station</label> - <output id="tradeLvl">20</output>
                    <input type="range" name="trade" id="trade" min="1" max="40" value="20" oninput="tradeLvl.value = trade.value">
                </fieldset>
            </div>
        </div>

        <div class="cols">
            <div class="col-2">
                <h3>Catacombs</h3>

                <fieldset>
                    <label for="catacombs_floors">Catacombs Floors Explored</label> - <output id="catacombs_floorsLvl">1</output>
                    <input type="range" name="catacombs_floors" id="catacombs_floors" min="1" max="55" value="1" oninput="catacombs_floorsLvl.value = catacombs_floors.value">
                </fieldset>

                <fieldset>
                    <label for="satchel">Satchel Capacity</label>
                    <input type="number" name="satchel" id="satchel" min="1" max="9999" value="1">
                </fieldset>
            </div>

            <div class="col-2">
                <h3>Spirit Mines</h3>

                <fieldset>
                    <label for="mines_floors">Spirit Mines Floors Explored</label> - <output id="mines_floorsLvl">1</output>
                    <input type="range" name="mines_floors" id="mines_floors" min="1" max="18" value="1" oninput="mines_floorsLvl.value = mines_floors.value">
                </fieldset>

                <fieldset>
                    <label for="crystals">Avg Crystals Mined per day</label>
                    <input type="number" name="crystals" id="crystals" min="0" max="1000000" value="360000">
                </fieldset>
            </div>
        </div>
      
        <button>Submit</button>
      </form>
  </article>
</section>

<footer>
  <p>&copy; 2018 shriekz. All rights reserved.</p>
</footer>

<script type="text/javascript">

    var buildingsObj = null;
    var catacombsObj = null;
    var costObj = null;
    var rssObj = null;
    var spirit_minesObj = null;

    var path = "meta/%WHAT%.json";

    $(document).ready(function() {
        $("#result").hide();
        $("#planner").show();

        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1;
        var yyyy = today.getFullYear();

        if(dd<10) { dd='0'+dd } 
        if(mm<10) { mm='0'+mm } 

        today = yyyy+'-'+mm+'-'+dd;
        limit = (yyyy+1)+'-'+mm+'-'+dd;
        
        $("#castle_to").attr("min", parseInt($("#castleLvl").val()) + 1);

        $("#targetBy").attr("min", today);
        $("#targetBy").attr("max", limit);
        $("#targetBy").val(today);
        
        loadData();
    });

    function reflectTarget() {
        
        if($("#castle_to").attr("min") >= $("#castle_to").attr("max")) {
            $("#castle_to").val(($("#castle_to").val() <= $("#castleLvl").val()) ? $("#castleLvl").val() : $("#castle_to").val());
            $("#castle_to").attr("min", $("#castle_to").attr("max"));
        } else {
            $("#castle_to").val(($("#castle_to").val() <= $("#castleLvl").val()) ? parseInt($("#castleLvl").val()) + 1 : $("#castle_to").val());
            $("#castle_to").attr("min", parseInt($("#castleLvl").val()) + 1);        
        }
    }

    function cleanUp() {
        $("#result").hide();
        $("#planner").show();

        $("#castleTarget").val("");
        $("#castleTargetBy").val("");

        $("#targetUpgrades").html("")
        $("#targetRssCost").html("");
        $("#totalTime").val("");
    }

    function doSubmit() {
        $("#result").show();
        $("#planner").hide();

        $("#castleTarget").val($("#castle_to").val());
        $("#castleTargetBy").val($("#targetBy").val());

        var resp = {
            "plan_id" : $("#plan_id").val(),
            "target" : {
                "castle" : parseInt($("#castle_to").val()),
                "by" : $("#targetBy").val()
            },
            "buildings" : {
                "castle" : parseInt($("#castleLvl").val()),
                "academy" : parseInt($("#academyLvl").val()),
                "airship" : parseInt($("#airshipLvl").val()),
                "artillery" : parseInt($("#artilleryLvl").val()),
                "infantry" : parseInt($("#infantryLvl").val()),
                "castle" : parseInt($("#castleLvl").val()),
                "embassy" : parseInt($("#embassyLvl").val()),
                "farm" : parseInt($("#farmLvl").val()),
                "forge" : parseInt($("#forgeLvl").val()),
                "warhall" : parseInt($("#warhallLvl").val()),
                "hospital" : parseInt($("#hospitalLvl").val()),
                "ironMine" : parseInt($("#ironMineLvl").val()),
                "lookout" : parseInt($("#lookoutLvl").val()),
                "lumberyard" : parseInt($("#lumberyardLvl").val()),
                "militaryTent" : parseInt($("#militaryTentLvl").val()),
                "munitions" : parseInt($("#munitionsLvl").val()),
                "distance" : parseInt($("#distanceLvl").val()),
                "silverMine" : parseInt($("#silverMineLvl").val()),
                "cavalry" : parseInt($("#cavalryLvl").val()),
                "trade" : parseInt($("#tradeLvl").val()),
                "traps" : parseInt($("#trapsLvl").val()),
                "wall" : parseInt($("#wallLvl").val()),
                "warehouse" : parseInt($("#warehouseLvl").val())
            },
            "catacombs" : {
                "floors" : parseInt($("#catacombs_floorsLvl").val()),
                "coins" : parseInt($("#satchel").val())
            },
            "spirit_mines" : {
                "floors" : parseInt($("#mines_floorsLvl").val()),
                "crystals" : parseInt($("#crystals").val())
            }
        };

        setPlan(resp);
    };

    function setPlan(resp) {
        preparePlan(resp);
        //setTargetTime();
        //setTargetRss();
        //setTargetUpgrades();
        //cleanUp();
    }

    function preparePlan(resp) {
        var htmlRssHolder = "";
        var htmlUpgHolder = "";
        var rssList = { "Food" : 0, "Wood" : 0, "Iron" : 0, "Silver" : 0 };
        var totalTime = "0d 0:00:00";

        var currentCastleObj = buildingsObj.filter(obj => {
            return obj.name == "Castle"
        })[0];

        for (var i = resp.buildings.castle + 1; i <= resp.target.castle; i++) {
            // console.log("loop " + i + " of " + resp.target.castle);
            var currentCostObj = costObj.filter(obj => {
                return obj.building == currentCastleObj.id && obj.level == i
            })[0];
            $.each(buildingsObj, function(index) {
                var upgBuilding = currentCostObj.needs.filter(obj => {
                    return obj.k == buildingsObj[index].id
                })[0];
                if(upgBuilding != undefined) {
                    htmlUpgHolder += "<li>" + buildingsObj[index].name + " - " + upgBuilding.v + "</li>";
                }
            });
            $.each(rssObj, function(index) {
                rssList[rssObj[index].name] += parseInt(currentCostObj[rssObj[index].name.toLowerCase()]);
            });
            totalTime = addTime(currentCostObj.time, totalTime);
        }

        $.each(rssList, function(k, v) {
            htmlRssHolder += "<li>" + k + " - " + formatRssAmount(v) + "</li>";
        });

        $("#targetRssCost").html(htmlRssHolder);
        $("#targetUpgrades").html(htmlUpgHolder);
        $("#totalTime").val(totalTime);
    }

    function addTime(addThis, toThis) {
        var addThisParts = splitTime(addThis);
        var toThisParts = splitTime(toThis);

        toThisParts.secs += addThisParts.secs;
        toThisParts.mins += addThisParts.mins;
        toThisParts.hours += addThisParts.hours;

        toThisParts.days += addThisParts.days;

        return formatTime(toThisParts);
    }

    function splitTime(aTime) {
        var days = 0;
        var time = "";

        if(aTime.indexOf("d ") != -1) {
            var tmp = aTime.split("d ");
            days = parseInt(tmp[0]);
            time = tmp[1].split(":");
        } else {
            time = aTime.split(":");
        }

        return {
            "days" : days,
            "hours" : parseInt(time[0]),
            "mins" : parseInt(time[1]),
            "secs" : parseInt(time[2])
        };
    }

    function formatTime(aTime) {
        if(aTime.secs > 59) {
            aTime.mins += ~~(aTime.secs / 60);
            aTime.secs %= 60;
        }

        if(aTime.mins > 59) {
            aTime.hours += ~~(aTime.mins / 60);
            aTime.mins %= 60;
        }

        if(aTime.hours > 23) {
            aTime.days += ~~(aTime.hours / 24);
            aTime.hours %= 24;
        }

        return "" + aTime.days + "d " + pad(aTime.hours) + ":" + pad(aTime.mins) + ":" + pad(aTime.secs);
    }

    function pad(unit) {
        if(unit < 10) return "0" + unit;
        return unit;
    }

    function formatRssAmount(rssAmount) {
        return rssAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function loadData() {
        if(buildingsObj == null) $.getJSON(path.replace("%WHAT%", "buildings"), function(data) { buildingsObj = data; });
        if(catacombsObj == null) $.getJSON(path.replace("%WHAT%", "catacombs"), function(data) { catacombsObj = data; });
        if(costObj == null) $.getJSON(path.replace("%WHAT%", "cost"), function(data) { costObj = data; });
        if(rssObj == null) $.getJSON(path.replace("%WHAT%", "rss"), function(data) { rssObj = data; });
        if(spirit_minesObj == null) $.getJSON(path.replace("%WHAT%", "spirit_mines"), function(data) { spirit_minesObj = data; });
    }

</script>

</body>
</html>